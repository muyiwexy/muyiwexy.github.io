<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Continue sign-in</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
      .card { max-width: 520px; margin: 0 auto; padding: 18px; border: 1px solid #e6e6e6; border-radius: 12px; }
      h1 { font-size: 18px; margin: 0 0 10px; }
      p  { font-size: 14px; line-height: 1.4; margin: 8px 0; color: #333; }
      button {
        width: 100%;
        padding: 12px 14px;
        border: 0;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      .primary { background: #111; color: white; }
      .secondary { margin-top: 10px; background: #f2f2f2; color: #111; }
      .small { font-size: 12px; color: #666; margin-top: 12px; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>Continue in the app</h1>
      <p>We’re opening the Study Buddy app to finish signing you ina.</p>

      <button id="openBtn" class="primary">Open the app</button>
      <button id="copyBtn" class="secondary">Copy link (if it didn’t work)</button>

      <p class="small">
        If the app doesn’t open automatically, tap <b>Open the app</b>.
      </p>
      <p class="small" id="status"></p>
    </div>

    <script>
      // CHANGE THIS if your iOS/Android custom URL scheme is not "studybuddy"
      const APP_SCHEME = "studybuddy";
      const APP_PATH = "finishSignIn"; // your app-side route/handler name

      function getFullCurrentUrl() {
        // Firebase email sign-in links carry important query params (oobCode, mode, apiKey, etc.)
        return window.location.href;
      }

      function buildAppUrl(fullHttpsLink) {
        // Pass the FULL https link into the app as a single query param.
        // In Flutter, you'll read uri.queryParameters["link"] and feed it to FirebaseAuth.
        const encoded = encodeURIComponent(fullHttpsLink);
        return `${APP_SCHEME}://${APP_PATH}?link=${encoded}`;
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (_) {
          // Fallback for older browsers
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          } catch (e) {
            document.body.removeChild(ta);
            return false;
          }
        }
      }

      function openApp() {
        const full = getFullCurrentUrl();
        const appUrl = buildAppUrl(full);

        // iOS often blocks automatic scheme opens unless initiated by a user gesture.
        // We still try on page load; if blocked, the button will work.
        window.location.href = appUrl;

        const status = document.getElementById("status");
        status.textContent = `Tried opening: ${appUrl}`;
      }

      // Wire buttons
      document.getElementById("openBtn").addEventListener("click", openApp);

      document.getElementById("copyBtn").addEventListener("click", async () => {
        const full = getFullCurrentUrl();
        const ok = await copyToClipboard(full);
        document.getElementById("status").textContent =
          ok ? "Link copied. Paste it into the app if needed." : "Could not copy automatically.";
      });

      // Attempt auto-open shortly after load (best-effort)
      window.addEventListener("load", () => {
        setTimeout(openApp, 350);
      });
    </script>
  </body>
</html>
